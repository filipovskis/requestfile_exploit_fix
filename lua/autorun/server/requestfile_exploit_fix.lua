-- RequestFile exploit fix provided by tochnonement (2022)
--
-- The exploit works only for x32 servers which has `sv_allowdownload` convar enabled
-- Basically the exploit just spams with the incredible amount of net messages to request files, the fix just limits the amount of messages in tick
--
-- Credits to creators of sourcenet -- Updated sourcenet by danielga from https://github.com/danielga/gm_sourcenet

include('sourcenet/incoming.lua')

local limits = {}
local name = 'sourcenet_RequestFile_ExploitFix'

hook.Add('PlayerInitialSpawn', name, function(ply)
	local netchan = CNetChan(ply:EntIndex())

	if not netchan then return end

    netchan.playerHasJoined = true
    netchan.playerSteamid = ply:SteamID()
end)

hook.Add('Tick', name, function()
    limits = {}
end)

FilterIncomingMessage(net_File, function(netchan, read, write)
    if netchan.playerHasJoined then
        local limit = limits[netchan] or 0
        if limit > 64 then
            netchan:Shutdown('exploits (RequestFile)')
            return
        end
        limits[netchan] = limit + 1
    end

    write:WriteUInt(net_File, NET_MESSAGE_BITS)

    local transferid = read:ReadUInt(32)
    write:WriteUInt(transferid, 32)

    local requested = read:ReadBit()
    write:WriteBit(requested)

    if requested == 0 then
        return
    end

    local requesttype = read:ReadUInt(1)
    write:WriteUInt(requesttype, 1)

    local fileid = read:ReadUInt(32)
    write:WriteUInt(fileid, 32)
end)